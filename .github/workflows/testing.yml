name: Testing Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOCKER_USERNAME: hymris
  FRONTEND_IMAGE: hymris/vitus-docker-uek-frontend
  BACKEND_IMAGE: hymris/vitus-docker-uek-backend

jobs:
  # Job 1: Detect Project Structure
  detect-structure:
    name: Detect Project Structure
    runs-on: ubuntu-latest
    outputs:
      has-frontend: ${{ steps.check.outputs.has-frontend }}
      has-backend: ${{ steps.check.outputs.has-backend }}
      is-monorepo: ${{ steps.check.outputs.is-monorepo }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check project structure
        id: check
        run: |
          # Check if we have frontend/ and backend/ directories (monorepo)
          if [ -d "frontend" ] && [ -d "backend" ]; then
            echo "has-frontend=true" >> $GITHUB_OUTPUT
            echo "has-backend=true" >> $GITHUB_OUTPUT
            echo "is-monorepo=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Monorepo structure detected"
          # Check if we're in a frontend-only repo
          elif [ -f "package.json" ]; then
            echo "has-frontend=true" >> $GITHUB_OUTPUT
            echo "has-backend=false" >> $GITHUB_OUTPUT
            echo "is-monorepo=false" >> $GITHUB_OUTPUT
            echo "ðŸŽ¨ Frontend-only repository detected"
          # Check if we're in a backend-only repo
          elif [ -f "pom.xml" ] || [ -f "build.gradle" ]; then
            echo "has-frontend=false" >> $GITHUB_OUTPUT
            echo "has-backend=true" >> $GITHUB_OUTPUT
            echo "is-monorepo=false" >> $GITHUB_OUTPUT
            echo "â˜• Backend-only repository detected"
          else
            echo "has-frontend=false" >> $GITHUB_OUTPUT
            echo "has-backend=false" >> $GITHUB_OUTPUT
            echo "is-monorepo=false" >> $GITHUB_OUTPUT
            echo "â“ Unknown structure"
          fi

  # Job 2: Frontend Code Quality
  frontend-quality:
    name: Frontend Code Quality
    runs-on: ubuntu-latest
    needs: detect-structure
    if: needs.detect-structure.outputs.has-frontend == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Determine working directory
        id: workdir
        run: |
          if [ "${{ needs.detect-structure.outputs.is-monorepo }}" == "true" ]; then
            echo "dir=./frontend" >> $GITHUB_OUTPUT
          else
            echo "dir=." >> $GITHUB_OUTPUT
          fi

      - name: Cache node modules
        uses: actions/cache@v3
        with:
          path: ${{ steps.workdir.outputs.dir }}/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles(format('{0}/package-lock.json', steps.workdir.outputs.dir)) }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        working-directory: ${{ steps.workdir.outputs.dir }}
        run: npm ci || npm install

      - name: Run ESLint
        working-directory: ${{ steps.workdir.outputs.dir }}
        run: |
          npm run lint || echo "âš ï¸ ESLint not configured or failed"
        continue-on-error: true

      - name: Run Prettier check
        working-directory: ${{ steps.workdir.outputs.dir }}
        run: |
          npx prettier --check "src/**/*.{js,jsx,ts,tsx,css,scss}" || echo "âš ï¸ Prettier check failed or not configured"
        continue-on-error: true

  # Job 3: Frontend Unit Tests
  frontend-tests:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    needs: detect-structure
    if: needs.detect-structure.outputs.has-frontend == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Determine working directory
        id: workdir
        run: |
          if [ "${{ needs.detect-structure.outputs.is-monorepo }}" == "true" ]; then
            echo "dir=./frontend" >> $GITHUB_OUTPUT
          else
            echo "dir=." >> $GITHUB_OUTPUT
          fi

      - name: Cache node modules
        uses: actions/cache@v3
        with:
          path: ${{ steps.workdir.outputs.dir }}/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles(format('{0}/package-lock.json', steps.workdir.outputs.dir)) }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        working-directory: ${{ steps.workdir.outputs.dir }}
        run: npm ci || npm install

      - name: Run tests
        working-directory: ${{ steps.workdir.outputs.dir }}
        run: |
          npm test -- --coverage --watchAll=false --passWithNoTests || echo "âš ï¸ Tests completed with warnings"
        env:
          CI: true
        continue-on-error: true

      - name: Upload coverage
        if: hashFiles(format('{0}/coverage/lcov.info', steps.workdir.outputs.dir)) != ''
        uses: codecov/codecov-action@v3
        with:
          files: ${{ steps.workdir.outputs.dir }}/coverage/lcov.info
          flags: frontend
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-results
          path: |
            ${{ steps.workdir.outputs.dir }}/coverage/
            ${{ steps.workdir.outputs.dir }}/test-results/
          if-no-files-found: ignore

  # Job 4: Backend Code Quality
  backend-quality:
    name: Backend Code Quality
    runs-on: ubuntu-latest
    needs: detect-structure
    if: needs.detect-structure.outputs.has-backend == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Determine working directory
        id: workdir
        run: |
          if [ "${{ needs.detect-structure.outputs.is-monorepo }}" == "true" ]; then
            echo "dir=./backend" >> $GITHUB_OUTPUT
          else
            echo "dir=." >> $GITHUB_OUTPUT
          fi

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles(format('{0}/pom.xml', steps.workdir.outputs.dir)) }}
          restore-keys: ${{ runner.os }}-m2

      - name: Run Checkstyle
        working-directory: ${{ steps.workdir.outputs.dir }}
        run: |
          mvn checkstyle:check || echo "âš ï¸ Checkstyle not configured or failed"
        continue-on-error: true

  # Job 5: Backend Unit Tests
  backend-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    needs: detect-structure
    if: needs.detect-structure.outputs.has-backend == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Determine working directory
        id: workdir
        run: |
          if [ "${{ needs.detect-structure.outputs.is-monorepo }}" == "true" ]; then
            echo "dir=./backend" >> $GITHUB_OUTPUT
          else
            echo "dir=." >> $GITHUB_OUTPUT
          fi

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles(format('{0}/pom.xml', steps.workdir.outputs.dir)) }}
          restore-keys: ${{ runner.os }}-m2

      - name: Run tests
        working-directory: ${{ steps.workdir.outputs.dir }}
        run: |
          mvn test -B || echo "âš ï¸ Tests completed with warnings"
        continue-on-error: true

      - name: Generate coverage
        working-directory: ${{ steps.workdir.outputs.dir }}
        run: |
          mvn jacoco:report || echo "âš ï¸ Coverage report not generated"
        continue-on-error: true

      - name: Upload coverage
        if: hashFiles(format('{0}/target/site/jacoco/jacoco.xml', steps.workdir.outputs.dir)) != ''
        uses: codecov/codecov-action@v3
        with:
          files: ${{ steps.workdir.outputs.dir }}/target/site/jacoco/jacoco.xml
          flags: backend
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: |
            ${{ steps.workdir.outputs.dir }}/target/surefire-reports/
            ${{ steps.workdir.outputs.dir }}/target/site/jacoco/
          if-no-files-found: ignore

  # Job 6: Docker Build Test
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: detect-structure
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Frontend image (if exists)
        if: needs.detect-structure.outputs.has-frontend == 'true'
        run: |
          if [ "${{ needs.detect-structure.outputs.is-monorepo }}" == "true" ]; then
            docker build -t ${{ env.FRONTEND_IMAGE }}:test ./frontend || echo "âš ï¸ Frontend build failed"
          else
            docker build -t ${{ env.FRONTEND_IMAGE }}:test . || echo "âš ï¸ Frontend build failed"
          fi
        continue-on-error: true

      - name: Build Backend image (if exists)
        if: needs.detect-structure.outputs.has-backend == 'true'
        run: |
          if [ "${{ needs.detect-structure.outputs.is-monorepo }}" == "true" ]; then
            docker build -t ${{ env.BACKEND_IMAGE }}:test ./backend || echo "âš ï¸ Backend build failed"
          else
            docker build -t ${{ env.BACKEND_IMAGE }}:test . || echo "âš ï¸ Backend build failed"
          fi
        continue-on-error: true

      - name: Test Frontend image
        if: needs.detect-structure.outputs.has-frontend == 'true'
        run: |
          docker run --rm ${{ env.FRONTEND_IMAGE }}:test nginx -t || echo "âš ï¸ Frontend image test failed"
        continue-on-error: true

  # Job 7: Security Scan
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: detect-structure
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine working directories
        id: workdir
        run: |
          if [ "${{ needs.detect-structure.outputs.is-monorepo }}" == "true" ]; then
            echo "frontend-dir=./frontend" >> $GITHUB_OUTPUT
            echo "backend-dir=./backend" >> $GITHUB_OUTPUT
          else
            echo "frontend-dir=." >> $GITHUB_OUTPUT
            echo "backend-dir=." >> $GITHUB_OUTPUT
          fi

      - name: Run npm audit (Frontend)
        if: needs.detect-structure.outputs.has-frontend == 'true'
        working-directory: ${{ steps.workdir.outputs.frontend-dir }}
        run: |
          npm audit --audit-level=moderate || echo "âš ï¸ npm audit found vulnerabilities"
        continue-on-error: true

      - name: Set up JDK (Backend)
        if: needs.detect-structure.outputs.has-backend == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Run OWASP Dependency Check (Backend)
        if: needs.detect-structure.outputs.has-backend == 'true'
        working-directory: ${{ steps.workdir.outputs.backend-dir }}
        run: |
          mvn org.owasp:dependency-check-maven:check || echo "âš ï¸ Dependency check found issues"
        continue-on-error: true

  # Job 8: Test Summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [detect-structure, frontend-quality, frontend-tests, backend-quality, backend-tests, docker-build, security-scan]
    if: always()
    
    steps:
      - name: Create summary
        run: |
          echo "# ðŸ§ª Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Project Structure" >> $GITHUB_STEP_SUMMARY
          echo "- **Has Frontend:** ${{ needs.detect-structure.outputs.has-frontend }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Has Backend:** ${{ needs.detect-structure.outputs.has-backend }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Monorepo:** ${{ needs.detect-structure.outputs.is-monorepo }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.detect-structure.outputs.has-frontend }}" == "true" ]; then
            echo "- Frontend Quality: ${{ needs.frontend-quality.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- Frontend Tests: ${{ needs.frontend-tests.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect-structure.outputs.has-backend }}" == "true" ]; then
            echo "- Backend Quality: ${{ needs.backend-quality.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- Backend Tests: ${{ needs.backend-tests.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- Docker Build: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Workflow completed!" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const hasFrontend = '${{ needs.detect-structure.outputs.has-frontend }}' === 'true';
            const hasBackend = '${{ needs.detect-structure.outputs.has-backend }}' === 'true';
            
            let body = '## ðŸ§ª Test Results\n\n';
            
            if (hasFrontend) {
              body += '### Frontend\n';
              body += `- Quality: ${{ needs.frontend-quality.result }}\n`;
              body += `- Tests: ${{ needs.frontend-tests.result }}\n\n`;
            }
            
            if (hasBackend) {
              body += '### Backend\n';
              body += `- Quality: ${{ needs.backend-quality.result }}\n`;
              body += `- Tests: ${{ needs.backend-tests.result }}\n\n`;
            }
            
            body += '### Other\n';
            body += `- Docker Build: ${{ needs.docker-build.result }}\n`;
            body += `- Security: ${{ needs.security-scan.result }}\n\n`;
            body += `[View full report](${context.payload.repository.html_url}/actions/runs/${context.runId})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
        continue-on-error: true
